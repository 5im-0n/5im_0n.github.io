<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base href="/">
  <title>
    
      Setting up Dovecot with Fetchmail and SpamAssassin
    
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  
<link rel="stylesheet" href="/css/app.css">

  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Source+Code+Pro'>
<meta name="generator" content="Hexo 6.0.0"></head>

<body>
  <nav class="app-nav no-print">
  
    
      <a href="/.">home</a>
    
  
    
      <a href="/archives/">archive</a>
    
  
    
      <a href="/about/">about</a>
    
  
    
      <a target="_blank" rel="noopener" href="https://git.e.tern.al/explore/repos">projects</a>
    
  
    
      <a href="/atom.xml">rss</a>
    
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/dovecot/">Setting up Dovecot with Fetchmail and SpamAssassin</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">June 23 2022</p>
  </section>

  <section class="article-entry">
    <p>Dovecot is a really cool imap server. If you, like me, have a lot of mail accounts around the internet, a bit of gmail there, some hotmail over here, and want to collect everything on your nice local home server, this is the howto to follow.</p>
<h2 id="Fetchmail"><a href="#Fetchmail" class="headerlink" title="Fetchmail"></a>Fetchmail</h2><p>First of all we need to configure Fetchmail to fetch our mail. Fetchmail can&#39;t handle multiple IMAP accounts with IDLE with a single Fetchmail running, so we need to run multiple Fetchmail instances, one for each IMAP account we want to monitor.<br>To do this we use <a target="_blank" rel="noopener" href="https://www.leonerd.org.uk/hacks/hints/fetchmultimail.html">this</a> script:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># searches for subdirectories of $HOME/.fetchmail, and considers each as a</span><br><span class="line"># directory to run fetcmail from. The config should be stored as &quot;fetchmailrc&quot;</span><br><span class="line"># within this directory; without the leading &quot;.&quot;. Networks can be started and</span><br><span class="line"># stopped independently, or all together. See the --help option for detail on</span><br><span class="line"># invoking the script.</span><br><span class="line"></span><br><span class="line">FETCHMAILROOT=~/.fetchmail</span><br><span class="line"></span><br><span class="line">cd &quot;$FETCHMAILROOT&quot;</span><br><span class="line"></span><br><span class="line">ACTION=&quot;start&quot;</span><br><span class="line"></span><br><span class="line">while [ &quot;$1&quot; ]; do</span><br><span class="line">  ARG=&quot;$1&quot;</span><br><span class="line">  case &quot;$ARG&quot; in</span><br><span class="line">    -k|--kill) ACTION=&quot;kill&quot; ;;</span><br><span class="line">    -l|--list) ACTION=&quot;list&quot; ;;</span><br><span class="line">    -h|--help) ACTION=&quot;help&quot; ;;</span><br><span class="line">    --) shift; break ;;</span><br><span class="line">    -*) echo &quot;Unknown argument $ARG&quot;; exit 1 ;;</span><br><span class="line">    *) break ;;</span><br><span class="line">  esac</span><br><span class="line">  shift</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">WHICH=&quot;$1&quot;</span><br><span class="line"></span><br><span class="line">function find_fetchmail_homes() &#123;</span><br><span class="line">  # Find directories immediately off FETCHMAILROOT</span><br><span class="line">  for ENT in *; do</span><br><span class="line">    if [ -d &quot;$ENT&quot; ]; then</span><br><span class="line">      echo &quot;$ENT&quot;</span><br><span class="line">    fi</span><br><span class="line">  done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case &quot;$ACTION&quot; in</span><br><span class="line">  help)</span><br><span class="line">    echo &quot;$0: [options..] [network]&quot;</span><br><span class="line">    echo &quot;Options are:&quot;</span><br><span class="line">    echo &quot; -h, --help:    This text&quot;</span><br><span class="line">    echo &quot; -k, --kill:    Stop network&quot;</span><br><span class="line">    echo &quot; -l, --list:    List networks, running or not&quot;</span><br><span class="line">    echo &quot;If a network is named, the action applies only to that network&quot;</span><br><span class="line">    exit 0</span><br><span class="line">    ;;</span><br><span class="line">  start)</span><br><span class="line">    for ENT in `find_fetchmail_homes`; do</span><br><span class="line">      if [ &quot;$WHICH&quot; -a &quot;$ENT&quot; != &quot;$WHICH&quot; ]; then continue; fi</span><br><span class="line">      export FETCHMAILHOME=`pwd`/$ENT</span><br><span class="line"></span><br><span class="line">      fetchmail $EXTRAOPTS #$ENT</span><br><span class="line">    done</span><br><span class="line">    ;;</span><br><span class="line">  list)</span><br><span class="line">    for ENT in `find_fetchmail_homes`; do</span><br><span class="line">      if [ &quot;$WHICH&quot; -a &quot;$ENT&quot; != &quot;$WHICH&quot; ]; then continue; fi</span><br><span class="line">      export FETCHMAILHOME=`pwd`/$ENT</span><br><span class="line">      FETCHMAILPID=$FETCHMAILHOME/fetchmail.pid</span><br><span class="line"></span><br><span class="line">      echo &quot;Config $ENT in $FETCHMAILHOME&quot;</span><br><span class="line">      if [ -r $FETCHMAILPID ]; then</span><br><span class="line">        echo &quot;  running as PID `cat $FETCHMAILPID`&quot;</span><br><span class="line">      else</span><br><span class="line">        echo &quot;  not running&quot;</span><br><span class="line">      fi</span><br><span class="line">    done</span><br><span class="line">    ;;</span><br><span class="line">  kill)</span><br><span class="line">    for ENT in `find_fetchmail_homes`; do</span><br><span class="line">      if [ &quot;$WHICH&quot; -a &quot;$ENT&quot; != &quot;$WHICH&quot; ]; then continue; fi</span><br><span class="line">      export FETCHMAILHOME=`pwd`/$ENT</span><br><span class="line">      FETCHMAILPID=$FETCHMAILHOME/fetchmail.pid</span><br><span class="line"></span><br><span class="line">      echo &quot;Config $ENT in $FETCHMAILHOME&quot;</span><br><span class="line">      if [ -r $FETCHMAILPID ]; then</span><br><span class="line">        fetchmail -q #$ENT</span><br><span class="line">      fi</span><br><span class="line">    done</span><br><span class="line">    ;;</span><br><span class="line">  *)</span><br><span class="line">    echo &quot;Ahh; unknown action $ACTION&quot;</span><br><span class="line">    exit 1</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure><br>We call it <code>fetchmultimail.sh</code> and save it somewhere, maybe in our <code>~/bin/fetchmultimail.sh</code>.</p>
<p>The script is configured with <code>fetchmailrc</code> files, one for every account:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ tree .fetchmail</span><br><span class="line">.fetchmail</span><br><span class="line">├── email1@gmail.com.INBOX@gmail.com</span><br><span class="line">│   └── fetchmailrc</span><br><span class="line">├── email2@outlook.com@imap-mail.outlook.com</span><br><span class="line">│   └── fetchmailrc</span><br><span class="line">└── email3@outlook.com@imap-mail.outlook.com</span><br><span class="line">    └── fetchmailrc</span><br><span class="line"></span><br><span class="line">3 directories, 3 files</span><br></pre></td></tr></table></figure></p>
<p>The <code>fetchmailrc</code> configuration file in those directories is a standard fetchmailrc file, and looks something like this:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">set postmaster &quot;postmaster&quot;</span><br><span class="line">set bouncemail</span><br><span class="line">set no spambounce</span><br><span class="line">set properties &quot;&quot;</span><br><span class="line">set daemon 300</span><br><span class="line">set invisible</span><br><span class="line">set syslog</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">poll imap-mail.outlook.com protocol IMAP port 993</span><br><span class="line">      user &#x27;email2@outlook.com&#x27; there with ssl with password &#x27;verysecureandsecretpassword&#x27; folder &#x27;INBOX&#x27; idle ssl</span><br><span class="line">      mda &quot;&#123; echo X-Mailbox: email2@outlook.com; cat; &#125; | spamc -s 5000000 | /usr/lib/dovecot/deliver -d s2&quot;</span><br></pre></td></tr></table></figure></p>
<p>So <code>fetchmail</code> fetches our mail from the IMAP server, and then delivers it to the <code>mda</code>. In this case, we</p>
<ul>
<li>add a header to the mail, so we can sort it to the correct folder later, with <code>&#123; echo X-Mailbox: email2@outlook.com; cat; &#125;</code></li>
<li>check for spam with SpamAssassin with <code>spamc -s 5000000</code></li>
<li>and then send it to Dovecot with <code>/usr/lib/dovecot/deliver -d s2</code>, where <code>s2</code> is the user we are delivering the mail to.</li>
</ul>
<p>To run this script on startup the easy way, we can use <code>crontab</code>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ crontab -l</span><br><span class="line">@reboot /home/s2/bin/fetchmultimail.sh &gt;/dev/null</span><br><span class="line">$</span><br></pre></td></tr></table></figure><br>This runs <code>fetchmultimal.sh</code> after every server startup.</p>
<h2 id="Dovecot"><a href="#Dovecot" class="headerlink" title="Dovecot"></a>Dovecot</h2><p>On the Dovecot side we now receive the mail, but we want to sort it to the correct folder using some custom rules. To do this, we can use <a target="_blank" rel="noopener" href="https://doc.dovecot.org/configuration_manual/sieve/">Sieve</a>.</p>
<p>So first of all, we install and configure Sieve for Dovecot. To do this follow the <a target="_blank" rel="noopener" href="https://doc.dovecot.org/configuration_manual/sieve/">official guide</a>, or one specific for your Linux distribution.</p>
<p>Once installed and configured Sieve, we can create a Sieve config file with the rules we want to have. A quick example:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">require &quot;fileinto&quot;;</span><br><span class="line"></span><br><span class="line">#webcam alerts</span><br><span class="line">if address :is [&quot;From&quot;] &quot;webcamalerts@home.in.tern.al&quot; &#123;</span><br><span class="line">  fileinto &quot;webcamalerts&quot;;</span><br><span class="line">  stop;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#spam</span><br><span class="line">if header &quot;X-Spam-Flag&quot; &quot;YES&quot; &#123;</span><br><span class="line">  fileinto &quot;Junk&quot;;</span><br><span class="line">  stop;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#email1@gmail.com</span><br><span class="line">if header &quot;X-Mailbox&quot; &quot;email1@gmail.com&quot; &#123;</span><br><span class="line">  fileinto &quot;email1@gmail_com&quot;;</span><br><span class="line">  stop;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#email2@outlook.com</span><br><span class="line">if header &quot;X-Mailbox&quot; &quot;email2@outlook.com&quot; &#123;</span><br><span class="line">  fileinto &quot;email2@outlook.com&quot;;</span><br><span class="line">  stop;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#email3@outlook.com</span><br><span class="line">if header &quot;X-Mailbox&quot; &quot;email3@outlook.com&quot; &#123;</span><br><span class="line">  fileinto &quot;email3@outlook.com&quot;;</span><br><span class="line">  stop;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fileinto &quot;INBOX&quot;;</span><br></pre></td></tr></table></figure></p>
<p>As you can see, we use the <code>X-Mailbox</code> header we set with Fetchmail to sort our mail. We could use the <code>To</code> header too, but if someone sends you an email where you are in the <code>Bcc</code> or the <code>Cc</code> filed, the <code>To</code> header field would be empty, so we use the custom <code>X-Mailbox</code> header we set by ourselves, so we are sure the mail arrived to that account, and gets put in the correct folder.</p>
<h2 id="The-end"><a href="#The-end" class="headerlink" title="The end"></a>The end</h2><p>So that was all. I skipped uninteresting stuff like how to install SpamAssassin and stuff like that, because it&#39;s Linux distribution dependent, and is very easy.</p>
<p>Hope the notes above helped someone!</p>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="https://secure.gravatar.com/avatar/8a0fbc625b09e72d7a8f2e77ac582e66?s=180&d=identicon" alt="avatar" />
    <div class="grid-item">
      <p class="title"> Simons stuff </p>
      <p class="subtitle">  </p>
    </div>
  </section>
</div>


  
</main>

</body>
</html>
