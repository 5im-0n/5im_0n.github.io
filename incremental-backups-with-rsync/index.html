<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base href="/">
  <title>
    
      Incremental backups with rsync
    
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  
<link rel="stylesheet" href="/css/app.css">

  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Source+Code+Pro'>
<meta name="generator" content="Hexo 6.0.0"></head>

<body>
  <nav class="app-nav no-print">
  
    
      <a href="/.">home</a>
    
  
    
      <a href="/archives/">archive</a>
    
  
    
      <a href="/about/">about</a>
    
  
    
      <a target="_blank" rel="noopener" href="https://git.e.tern.al/explore/repos">projects</a>
    
  
    
      <a href="/atom.xml">rss</a>
    
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/incremental-backups-with-rsync/">Incremental backups with rsync</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">February 27 2024</p>
  </section>

  <section class="article-entry">
    <p>A cronjob on a server rsyncs all files from different locations to a single folder. Then, that folder gets versioned and backed up again, so that we can go back in time. Optionally, everything can be encrypted and sent to a cloud storage for aditional safety.</p>
<p>So how does it work? First of all some configurations:</p>
<p>Let&#39;s make a <code>backup_config.sh</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">BACKUPDISK=/home/backupdisk</span><br><span class="line"></span><br><span class="line">#the backup folder</span><br><span class="line">BACKUPDIR=$BACKUPDISK/backup</span><br><span class="line"></span><br><span class="line">#folders by date and time</span><br><span class="line">ARCHIVEDIR=$BACKUPDISK/archive</span><br><span class="line"></span><br><span class="line">RSYNC_LOCK_FILE=/tmp/rsync.lock</span><br><span class="line"></span><br><span class="line">#this script will populate the archive</span><br><span class="line">INCREMENTAL=/home/s2/bin/backup/incremental.sh</span><br><span class="line"></span><br><span class="line">#how much the disk can be full before deleting old archives</span><br><span class="line">MAX_PERCENT_USED=85</span><br></pre></td></tr></table></figure></p>
<p>Then we need to actually backup some stuff to <code>$BACKUPDIR</code>. The <code>rsync_black.sh</code> is the script that backs up my windows desktop pc (his name is <code>black</code>). The script connects with ssh to the remote pc, and backs up the</p>
<ul>
<li><code>.gnupg</code>,</li>
<li><code>.ssh</code>,</li>
<li><code>AppData/Roaming/copyq</code>,</li>
<li><code>AppData/Roaming/Mozilla/Firefox/Profiles</code></li>
</ul>
<p>folders to <code>$BACKUPDIR/black/Users/s2/</code>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">. `dirname $0`/backup_config.sh</span><br><span class="line"></span><br><span class="line">host=black</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(</span><br><span class="line">flock -xn 200</span><br><span class="line">if [ $? != 0 ]; then exit 0; fi;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ping -c1 $host&gt;/dev/null 2&gt;&amp;1</span><br><span class="line">if [ $? != 0 ]; then exit 0; fi</span><br><span class="line"></span><br><span class="line">mkdir -p $BACKUPDIR/black</span><br><span class="line"></span><br><span class="line">mkdir -p $BACKUPDIR/black/Users/s2/ &amp;&amp; /home/s2/bin/backup/rsync-wrapper.sh \</span><br><span class="line">    -R -aqz --numeric-ids --delete-after --ignore-missing-args --exclude &#x27;*.lock&#x27; \</span><br><span class="line">    -e &#x27;ssh&#x27; s2@$host:.gnupg \</span><br><span class="line">    :.ssh \</span><br><span class="line">    :AppData/Roaming/copyq \</span><br><span class="line">    :AppData/Roaming/Mozilla/Firefox/Profiles \</span><br><span class="line">    $BACKUPDIR/black/Users/s2/</span><br><span class="line"></span><br><span class="line">$INCREMENTAL</span><br><span class="line"></span><br><span class="line">) 200&gt;$RSYNC_LOCK_FILE</span><br></pre></td></tr></table></figure></p>
<p>The script uses <a target="_blank" rel="noopener" href="https://git.samba.org/?p=rsync.git;a=blob_plain;f=support/rsync-no-vanished;hb=HEAD"><code>rsync-wrapper.sh</code></a>, because sometimes files on the running desktop vanish while being backed up, and we want to ignore this error. So we don&#39;t use <code>rsync</code> directly to backup, but wrap it with <code>rsync-wrapper.sh</code>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bash</span><br><span class="line"></span><br><span class="line">REAL_RSYNC=/usr/bin/rsync</span><br><span class="line">IGNOREEXIT=24</span><br><span class="line">IGNOREOUT=&#x27;^(file has vanished: |rsync warning: some files vanished before they could be transferred)&#x27;</span><br><span class="line"></span><br><span class="line"># If someone installs this as &quot;rsync&quot;, make sure we don&#x27;t affect a server run.</span><br><span class="line">for arg in &quot;$&#123;@&#125;&quot;; do</span><br><span class="line">    if [[ &quot;$arg&quot; == --server ]]; then</span><br><span class="line">	exec $REAL_RSYNC &quot;$&#123;@&#125;&quot;</span><br><span class="line">	exit $? # Not reached</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">set -o pipefail</span><br><span class="line"></span><br><span class="line"># This filters stderr without merging it with stdout:</span><br><span class="line">&#123; $REAL_RSYNC &quot;$&#123;@&#125;&quot; 2&gt;&amp;1 1&gt;&amp;3 3&gt;&amp;- | grep -E -v &quot;$IGNOREOUT&quot;; ret=$&#123;PIPESTATUS[0]&#125;; &#125; 3&gt;&amp;1 1&gt;&amp;2</span><br><span class="line"></span><br><span class="line">if [[ $ret == $IGNOREEXIT ]]; then</span><br><span class="line">    ret=0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">exit $ret</span><br></pre></td></tr></table></figure></p>
<p>Like our <code>rsync_black.sh</code> file above, we can create more files like that, to backup other computers. For example <code>rsync_31337.it.sh</code> backs up folders on a remote server:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">. `dirname $0`/backup_config.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(</span><br><span class="line">flock -xn 200</span><br><span class="line">if [ $? != 0 ]; then exit 0; fi;</span><br><span class="line"></span><br><span class="line">mkdir -p $BACKUPDIR/31337.it</span><br><span class="line"></span><br><span class="line">rsync -R -aqz --numeric-ids --delete-after -e &#x27;ssh -p 22022&#x27; \</span><br><span class="line">    --exclude /home/n3wz/n3wz/run/solr/solr-5.3.1/server/solr/fcku/data \</span><br><span class="line">    root@vps.31337.it:/home/vmail \</span><br><span class="line">    :/home/s2 \</span><br><span class="line">    :/root \</span><br><span class="line">    :/home/n3wz \</span><br><span class="line">    :/etc/letsencrypt \</span><br><span class="line">    :/etc/postfix \</span><br><span class="line">    :/etc/postgresql \</span><br><span class="line">    :/etc/postgresql-common \</span><br><span class="line">    :/etc/apache2 \</span><br><span class="line">    :/etc/news \</span><br><span class="line">    :/etc/prosody \</span><br><span class="line">    :/etc/dovecot \</span><br><span class="line">    :/etc/default \</span><br><span class="line">    :/etc/dkimkeys \</span><br><span class="line">    :/etc/opendkim.conf \</span><br><span class="line">    :/etc/opendmarc.conf \</span><br><span class="line">    :/var/spool/cron/crontabs \</span><br><span class="line">    :/var/www \</span><br><span class="line">    $BACKUPDIR/31337.it/</span><br><span class="line"></span><br><span class="line">$INCREMENTAL</span><br><span class="line"></span><br><span class="line">) 200&gt;$RSYNC_LOCK_FILE</span><br></pre></td></tr></table></figure></p>
<p>Now we have all our folders from all our remote computers on <code>$BACKUPDIR</code>. We need to version them. <code>$INCREMENTAL</code> is responsible for that. This is <code>incremental.sh</code>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">. `dirname $0`/backup_config.sh</span><br><span class="line"></span><br><span class="line">CURBACKUPDATE=`date &quot;+%F_%T&quot;`</span><br><span class="line">BACKUPSUBDIR=`date &quot;+%Y/%m/%d&quot;`</span><br><span class="line"></span><br><span class="line">mkdir -p $ARCHIVEDIR/$BACKUPSUBDIR                             &amp;&amp;</span><br><span class="line"></span><br><span class="line">nice -n 10 rsync -aq --inplace --numeric-ids \</span><br><span class="line">           --link-dest=$ARCHIVEDIR/backup_current \</span><br><span class="line">           $BACKUPDIR/ \</span><br><span class="line">           $ARCHIVEDIR/$BACKUPSUBDIR/backup_$CURBACKUPDATE     &amp;&amp;</span><br><span class="line">(cd $ARCHIVEDIR &amp;&amp; rm backup_current &amp;&amp; ln -sf $BACKUPSUBDIR/backup_$CURBACKUPDATE backup_current)</span><br></pre></td></tr></table></figure></p>
<p>in <code>$ARCHIVEDIR</code> we create a lot of folders named with date and time, that contain our backup at a given point in time, so we can recover everything in case of lost data.</p>
<p>When our backupdisk reaches <code>$MAX_PERCENT_USED</code>, we need to clean up, by deleting old archives. To do that, we use <code>remove_old.sh</code>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">. `dirname $0`/backup_config.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">get_used_space() &#123;</span><br><span class="line">	local inodes=`df -i $BACKUPDISK|grep &#x27;dev&#x27;|awk &#x27;&#123;print $5&#125;&#x27;|sed &#x27;s/%//&#x27;`</span><br><span class="line">	local space=`df $BACKUPDISK|grep &#x27;dev&#x27;|awk &#x27;&#123;print $5&#125;&#x27;|sed &#x27;s/%//&#x27;`</span><br><span class="line"></span><br><span class="line">	if [ $inodes -gt $space ]; then</span><br><span class="line">                used_space=$inodes</span><br><span class="line">	else</span><br><span class="line">		used_space=$space</span><br><span class="line">	fi</span><br><span class="line">	echo used space is $used_space</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_used_space() &#123;</span><br><span class="line">	get_used_space</span><br><span class="line">	if [ $used_space -lt $MAX_PERCENT_USED ]; then</span><br><span class="line">		echo used space is less than $MAX_PERCENT_USED</span><br><span class="line"></span><br><span class="line">                echo empty directoies</span><br><span class="line">                sudo find $ARCHIVEDIR/????/?? -depth -maxdepth 1 -empty -type d -exec rm -rf &#123;&#125; \;</span><br><span class="line">                sudo find $ARCHIVEDIR/???? -depth -maxdepth 2 -empty -type d -exec rm -rf &#123;&#125; \;</span><br><span class="line"></span><br><span class="line">		echo exiting</span><br><span class="line">		exit 0</span><br><span class="line">	fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(</span><br><span class="line">flock -xn 200</span><br><span class="line">  if [ $? != 0 ]; then exit 0; fi;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  check_used_space</span><br><span class="line"></span><br><span class="line">  for stuff in `ls -tr1d $ARCHIVEDIR/????/??/??`; do</span><br><span class="line">	echo deleting $stuff</span><br><span class="line">	sudo rm -rf $stuff</span><br><span class="line">	check_used_space</span><br><span class="line">  done</span><br><span class="line"></span><br><span class="line">) 200&gt;$RSYNC_LOCK_FILE</span><br></pre></td></tr></table></figure></p>
<p>With all our files in one folder, we have everyhing in place. I have them in my home dir, in <code>/home/s2/bin/backup</code>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/home/s2/bin/backup</span><br><span class="line">|</span><br><span class="line">├─ backup_config.sh</span><br><span class="line">├─ incremental.sh</span><br><span class="line">├─ remove_old.sh</span><br><span class="line">├─ rsync_31337.it.sh</span><br><span class="line">├─ rsync_black.sh</span><br><span class="line">├─ rsync_home.sh</span><br><span class="line">├─ rsync_laptop.sh</span><br><span class="line">└─ rsync-wrapper.sh</span><br></pre></td></tr></table></figure></p>
<p>So, now if we run <code>rsync_31337.it.sh</code>, all our files from the computer 31337.it get copied over to our <code>$BACKUPDIR</code>, and <code>incremental.sh</code> will then create our backup folder in <code>archive</code>, representing our files at this specific point in time.</p>
<p><code>$ARCHIVEDIR</code> will look like this:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/home/backupdisk/archive/</span><br><span class="line">├── 2023</span><br><span class="line">│   ├── 04</span><br><span class="line">│   │   ├── 23</span><br><span class="line">│   │   │   ├── backup_2023-04-23_16:31:34</span><br><span class="line">│   │   │   └── backup_2023-04-23_18:30:29</span><br><span class="line">│   │   ├── 24</span><br><span class="line">│   │   │   └── backup_2023-04-24_10:40:45</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">├── 2024</span><br><span class="line">│   ├── 01</span><br><span class="line">│   │   ├── 01</span><br><span class="line">│   │   │   └── backup_2024-01-01_04:30:12</span><br><span class="line">│   │   └── 29</span><br><span class="line">│   │       └── backup_2024-01-29_04:32:43</span><br><span class="line">│   └── 02</span><br><span class="line">│       ├── 01</span><br><span class="line">│       │   └── backup_2024-02-01_04:32:45</span><br><span class="line">│       └── ...</span><br><span class="line">└── backup_current -&gt; 2024/02/27/backup_2024-02-27_04:30:19</span><br></pre></td></tr></table></figure></p>
<p>Now we just need to run them periodically with <code>cron</code>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#backup</span><br><span class="line">30 4   * * * sudo /home/s2/bin/backup/rsync_home.sh</span><br><span class="line">30 */2 * * * sudo /home/s2/bin/backup/rsync_black.sh</span><br><span class="line"></span><br><span class="line">45 */2 * * * sudo /home/s2/bin/backup/remove_old.sh &gt;/dev/null</span><br></pre></td></tr></table></figure></p>
<p>Done.</p>
<p>Optionally, we could compress and crypt our <code>$BACKUPDIR</code> or <code>$ARCHIVEDIR</code>, and upload everything to some cloud storage for additional safety.</p>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="https://secure.gravatar.com/avatar/8a0fbc625b09e72d7a8f2e77ac582e66?s=180&d=identicon" alt="avatar" />
    <div class="grid-item">
      <p class="title"> Simons stuff </p>
      <p class="subtitle">  </p>
    </div>
  </section>
</div>


  
</main>

</body>
</html>
